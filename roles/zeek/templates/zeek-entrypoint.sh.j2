#!/bin/bash
set -e

echo "Checking JA4+ installation..."
if [ ! -d "/usr/local/zeek/share/zeek/site/packages/ja4" ]; then
    apt-get update -qq && apt-get install -y -qq git ca-certificates 2>&1 | grep -v "debconf"
    zkg install --force https://github.com/FoxIO-LLC/ja4
    echo "JA4+ installed successfully!"
else
    echo "JA4+ already installed"
fi

echo "Starting Zeek..."
zeekctl deploy

sleep 5
zeekctl status

echo "Creating log symlink structure in /zeek-logs..."
mkdir -p /zeek-logs
ln -sf /usr/local/zeek/spool/zeek /zeek-logs/current

# Copy logs periodically
while true; do
    rsync -a --delete /usr/local/zeek/spool/zeek/ /zeek-logs/current/ 2>/dev/null || true
    sleep 60
done
