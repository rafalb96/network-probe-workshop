#!/bin/bash
set -e

echo "Checking JA4+ installation..."

# Check if JA4+ is already installed
if [ ! -d "/usr/local/zeek/share/zeek/site/packages/ja4" ]; then
    echo "Installing JA4+ Zeek package..."
    
    # Install dependencies
    echo "Installing git..."
    apt-get update -qq && apt-get install -y -qq git ca-certificates
    
    # Clean up and create fresh temp directory
    echo "Preparing temporary directory..."
    rm -rf /tmp/ja4-install
    mkdir -p /tmp/ja4-install
    cd /tmp/ja4-install
    
    # Clone JA4+ with full output for debugging
    echo "Cloning JA4+ repository..."
    git clone --depth 1 https://github.com/FoxIO-LLC/ja4.git
    
    if [ ! -d "ja4/zeek" ]; then
        echo "ERROR: JA4+ clone failed or zeek directory not found!"
        exit 1
    fi
    
    # Install JA4+ package
    echo "Installing JA4+ via zkg..."
    cd ja4/zeek
    zkg install --force .
    
    # Verify installation
    if [ -d "/usr/local/zeek/share/zeek/site/packages/ja4" ]; then
        echo "JA4+ installed successfully!"
    else
        echo "ERROR: JA4+ installation verification failed!"
        exit 1
    fi
else
    echo "JA4+ already installed, skipping installation"
fi

echo "Starting Zeek..."

# Start Zeek with zeekctl
zeekctl deploy

# Keep container running by tailing logs
tail -f /usr/local/zeek/logs/current/stdout.log
