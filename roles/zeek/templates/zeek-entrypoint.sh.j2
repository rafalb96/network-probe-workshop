#!/bin/bash
set -e

echo "Checking JA4+ installation..."

# Check if JA4+ is already installed
if [ ! -d "/usr/local/zeek/share/zeek/site/packages/ja4" ]; then
    echo "Installing JA4+ Zeek package..."
    
    # Install dependencies
    echo "Installing git..."
    apt-get update -qq && apt-get install -y -qq git ca-certificates 2>&1 | grep -v "debconf"
    
    # Install JA4+ directly from GitHub URL using zkg
    echo "Installing JA4+ via zkg from GitHub..."
    zkg install --force https://github.com/FoxIO-LLC/ja4
    
    # Verify installation
    if zkg list | grep -q ja4; then
        echo "JA4+ installed successfully!"
    else
        echo "ERROR: JA4+ installation verification failed!"
        exit 1
    fi
else
    echo "JA4+ already installed, skipping installation"
fi

# Show installed packages and structure
echo "Installed zkg packages:"
zkg list

echo "Package directory structure:"
ls -la /usr/local/zeek/share/zeek/site/packages/ || true

echo "Starting Zeek..."

# Start Zeek with zeekctl
zeekctl deploy

# Keep container running by tailing logs
tail -f /usr/local/zeek/logs/current/stdout.log
